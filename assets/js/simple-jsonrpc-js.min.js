!function(e){"use strict";var f=Promise;if(void 0===f&&(f=e.Promise),void 0===f)throw"Promise is not supported! Use latest version node/browser or promise-polyfill";function p(e){return void 0===e}function m(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}function l(e){return"function"==typeof e}function h(e){return"string"==typeof e}function v(e){if(m(e)){for(var r in e)if(e.hasOwnProperty(r))return;return 1}return y(e)?!e.length:!e}function g(e,r){if(y(e))return e.map(r);for(var n in e)e.hasOwnProperty(n)&&r(e[n])}var y=Array.isArray,O={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};function N(e,r,n){this.message=r||"",this.code=e||-32e3,Boolean(n)&&(this.data=n)}N.prototype=new Error;function r(){var o=this,s={},t=0,a={};function i(e,r){var n,t=(n=e,JSON.parse(JSON.stringify(n)));return r&&(m(r)&&r.hasOwnProperty("message")?t.data=r.message:h(r)&&(t.data=r),r instanceof N&&(t={message:r.message,code:r.code},r.hasOwnProperty("data")&&(t.data=r.data))),t}function u(e){try{return e.error?(t=e,void(s.hasOwnProperty(t.id)?s[t.id].reject(t.error):console.log("Unknown request",t))):(n=e).hasOwnProperty("result")&&n.hasOwnProperty("id")?(r=e,void(s.hasOwnProperty(r.id)?(s[r.id].resolve(r.result),delete s[r.id]):console.log("unknown request",r))):e.method?function(r){{if(!a.hasOwnProperty(r.method))return f.resolve({jsonrpc:"2.0",id:r.id,error:i(O.METHOD_NOT_FOUND,{message:r.method})});try{var e;if(r.hasOwnProperty("params")){if("pass"==a[r.method].params)e=a[r.method].fn.call(a,r.params);else if(y(r.params))e=a[r.method].fn.apply(a,r.params);else if(m(r.params)){if(!(a[r.method].params instanceof Array))return f.resolve({jsonrpc:"2.0",id:r.id,error:i(O.INVALID_PARAMS,"Undeclared arguments of the method "+r.method)});var n=[];if(a[r.method].params.forEach(function(e){r.params.hasOwnProperty(e)?(n.push(r.params[e]),delete r.params[e]):n.push(void 0)}),0<Object.keys(r.params).length)return f.resolve({jsonrpc:"2.0",id:r.id,error:i(O.INVALID_PARAMS,{message:"Params: "+Object.keys(r.params).toString()+" not used"})});e=a[r.method].fn.apply(a,n)}}else e=a[r.method].fn();return r.hasOwnProperty("id")?function(e){return e&&"function"==typeof e.then}(e)?e.then(function(e){return p(e)&&(e=!0),{jsonrpc:"2.0",id:r.id,result:e}}).catch(function(e){return{jsonrpc:"2.0",id:r.id,error:i(O.INTERNAL_ERROR,e)}}):(p(e)&&(e=!0),f.resolve({jsonrpc:"2.0",id:r.id,result:e})):f.resolve()}catch(e){return f.resolve({jsonrpc:"2.0",id:r.id,error:i(O.INTERNAL_ERROR,e)})}}}(e):f.resolve({id:null,jsonrpc:"2.0",error:i(O.INVALID_REQUEST)})}catch(e){return console.error("Resolver error:"+e.message,e),f.reject(e)}var r,n,t}function c(e,r){var n={jsonrpc:"2.0",method:e,params:r};return m(r)&&!v(r)&&(n.params=r),n}function d(e,r){var n={jsonrpc:"2.0",method:e,id:t+=1};return m(r)&&!v(r)&&(n.params=r),{promise:new f(function(e,r){s[t.toString()]={resolve:e,reject:r}}),message:n}}o.toStream=function(e){console.log("Need define the toStream method before use"),console.log(arguments)},o.dispatch=function(e,r,n){if(h(e)&&"pass"==r&&l(n))a[e]={fn:n,params:r};else if(h(e)&&y(r)&&l(n))a[e]={fn:n,params:r};else{if(!(h(e)&&l(r)&&p(n)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");a[e]={fn:r,params:null}}},o.on=o.dispatch,o.off=function(e){delete a[e]},o.call=function(e,r){var n=d(e,r);return o.toStream(JSON.stringify(n.message)),n.promise},o.notification=function(e,r){o.toStream(JSON.stringify(c(e,r)))},o.batch=function(e){var n=[],t=[];return g(e,function(e){var r;e.hasOwnProperty("call")?(r=d(e.call.method,e.call.params),t.push(r.message),n.push(r.promise.then(function(e){return e},function(e){return e}))):e.hasOwnProperty("notification")&&t.push(c(e.notification.method,e.notification.params))}),o.toStream(JSON.stringify(t)),f.all(n)},o.messageHandler=function(e){try{var r=JSON.parse(e);return t=[],y(n=r)?g(n,function(e){t.push(u(e))}):m(n)&&t.push(u(n)),f.all(t).then(function(e){var r=[];return g(e,function(e){p(e)||r.push(e)}),1===r.length?o.toStream(JSON.stringify(r[0])):1<r.length&&o.toStream(JSON.stringify(r)),e})}catch(e){return console.log("Error in messageHandler(): ",e),o.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:O.PARSE_ERROR})),f.reject(e)}var n,t},o.customException=function(e,r,n){return new N(e,r,n)}}if("function"==typeof define&&define.amd)define("simple_jsonrpc",[],function(){return r});else if("undefined"!=typeof module&&void 0!==module.exports)module.exports=r;else{if(void 0===e)return;e.simple_jsonrpc=r}}(this);